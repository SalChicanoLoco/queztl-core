#!/bin/bash
# Queztl Hive Control - Manage the distributed training system

set -e

COMPOSE_FILE="docker-compose.training.yml"
ORCHESTRATOR_URL="http://localhost:9000"

# Colors
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

echo -e "${BLUE}"
echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
echo "‚ïë                     QUEZTL HIVE CONTROL SYSTEM                             ‚ïë"
echo "‚ïë                Distributed ML Training Orchestration                       ‚ïë"
echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
echo -e "${NC}"

case "$1" in
    init)
        echo "üöÄ Initializing training hive..."
        
        # Build images
        echo "üì¶ Building orchestrator image..."
        docker-compose -f $COMPOSE_FILE build training-orchestrator
        
        echo "üì¶ Building runner image..."
        docker-compose -f $COMPOSE_FILE build training-runner-1
        
        # Create directories
        mkdir -p models training_logs data
        
        echo -e "${GREEN}‚úÖ Hive initialized!${NC}"
        echo ""
        echo "Next steps:"
        echo "  1. Run: ./hive-control start"
        echo "  2. Check: ./hive-control status"
        echo "  3. Scale: ./hive-control scale 4"
        ;;
    
    start)
        echo "üöÄ Starting training hive..."
        
        # Start orchestrator
        docker-compose -f $COMPOSE_FILE up -d training-orchestrator
        
        echo "‚è≥ Waiting for orchestrator..."
        sleep 5
        
        # Start initial runner
        docker-compose -f $COMPOSE_FILE --profile runner up -d training-runner-1
        
        echo -e "${GREEN}‚úÖ Hive started!${NC}"
        echo ""
        echo "Orchestrator: http://localhost:9000"
        echo "Status: ./hive-control status"
        ;;
    
    stop)
        echo "üõë Stopping training hive..."
        docker-compose -f $COMPOSE_FILE --profile runner down
        echo -e "${GREEN}‚úÖ Hive stopped${NC}"
        ;;
    
    restart)
        echo "üîÑ Restarting training hive..."
        $0 stop
        sleep 2
        $0 start
        ;;
    
    status)
        echo "üìä Hive Status:"
        echo ""
        
        # Check orchestrator
        if curl -sf $ORCHESTRATOR_URL/health > /dev/null 2>&1; then
            echo -e "${GREEN}‚úÖ Orchestrator: Running${NC}"
            
            # Get detailed status
            STATUS=$(curl -s $ORCHESTRATOR_URL/status)
            echo ""
            echo "üéØ System:"
            echo "$STATUS" | python3 -c "import sys, json; d=json.load(sys.stdin); print(f\"  CPU: {d['orchestrator']['system']['cpu_percent']:.1f}%\"); print(f\"  Memory: {d['orchestrator']['system']['memory_percent']:.1f}%\"); print(f\"  Disk: {d['orchestrator']['system']['disk_percent']:.1f}%\")"
            
            echo ""
            echo "üèÉ Runners:"
            echo "$STATUS" | python3 -c "import sys, json; d=json.load(sys.stdin); print(f\"  Active: {d['runners']['active']}\"); print(f\"  Available: {d['runners']['available']}\"); print(f\"  Max: {d['orchestrator']['max_runners']}\")"
            
            echo ""
            echo "üìã Queue:"
            echo "$STATUS" | python3 -c "import sys, json; d=json.load(sys.stdin); print(f\"  Pending: {d['queue']['pending']}\"); print(f\"  Completed: {d['queue']['completed']}\")"
            
        else
            echo -e "${RED}‚ùå Orchestrator: Not running${NC}"
        fi
        
        echo ""
        echo "üêã Containers:"
        docker ps -a --filter "name=queztl" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" | head -10
        ;;
    
    scale)
        if [ -z "$2" ]; then
            echo "Usage: ./hive-control scale <number>"
            echo "Example: ./hive-control scale 4"
            exit 1
        fi
        
        TARGET=$2
        echo "üìà Scaling to $TARGET runners..."
        
        RESULT=$(curl -s -X POST "$ORCHESTRATOR_URL/scale?target_runners=$TARGET")
        echo "$RESULT" | python3 -c "import sys, json; d=json.load(sys.stdin); print(f\"Action: {d['action']}\"); print(f\"From: {d.get('from', 'N/A')}\"); print(f\"To: {d.get('to', 'N/A')}\")"
        
        echo -e "${GREEN}‚úÖ Scaled!${NC}"
        ;;
    
    runners)
        echo "üèÉ Training Runners:"
        echo ""
        
        RUNNERS=$(curl -s $ORCHESTRATOR_URL/runners)
        echo "$RUNNERS" | python3 -c "
import sys, json
data = json.load(sys.stdin)
for r in data['runners']:
    status_icon = 'üü¢' if r['status'] == 'running' else 'üî¥'
    print(f\"{status_icon} {r['id']:25s} [{r['status']}]\")
    print(f\"   CPU: {r['cpu_usage']:.1f}% | Memory: {r['memory_mb']:.1f}MB\")
    print(f\"   Created: {r['created'][:19]}\")
    print()
print(f\"Total: {data['total']} runners\")
"
        ;;
    
    jobs)
        echo "üìã Training Jobs:"
        echo ""
        
        JOBS=$(curl -s $ORCHESTRATOR_URL/jobs)
        echo "$JOBS" | python3 -c "
import sys, json
data = json.load(sys.stdin)

print('‚è≥ Queued:')
for job in data['queued'][:5]:
    print(f\"  {job['job_id']} - {job['module_id']} (priority: {job['priority']})\")
if not data['queued']:
    print('  (none)')

print()
print('üîÑ Active:')
for job in data['active']:
    print(f\"  {job.get('runner_id', 'unknown')} - {job.get('current_job', 'unknown')}\")
if not data['active']:
    print('  (none)')

print()
print('‚úÖ Completed (last 5):')
for job in data['completed'][:5]:
    print(f\"  {job.get('job_id', 'unknown')} - {job.get('module_id', 'unknown')}\")
if not data['completed']:
    print('  (none)')
"
        ;;
    
    submit)
        if [ -z "$2" ]; then
            echo "Usage: ./hive-control submit <module-id> [priority]"
            echo ""
            echo "Available modules:"
            echo "  - image-to-3d"
            echo "  - enhanced-3d"
            echo "  - gis-lidar"
            echo "  - gis-buildings"
            echo "  - geophysics-magnetic"
            echo "  - geophysics-resistivity"
            echo "  - geophysics-seismic"
            echo ""
            echo "Priority: high, medium, low (default: medium)"
            exit 1
        fi
        
        MODULE=$2
        PRIORITY=${3:-medium}
        
        echo "üì§ Submitting job: $MODULE (priority: $PRIORITY)"
        
        RESULT=$(curl -s -X POST "$ORCHESTRATOR_URL/jobs/submit" \
            -H "Content-Type: application/json" \
            -d "{\"module_id\": \"$MODULE\", \"priority\": \"$PRIORITY\"}")
        
        echo "$RESULT" | python3 -c "import sys, json; d=json.load(sys.stdin); print(f\"Job ID: {d['job_id']}\"); print(f\"Status: {d['status']}\"); print(f\"Submitted: {d['submitted_at']}\")"
        
        echo -e "${GREEN}‚úÖ Job submitted!${NC}"
        ;;
    
    logs)
        if [ -z "$2" ]; then
            echo "Usage: ./hive-control logs <runner-id|module-id>"
            exit 1
        fi
        
        TARGET=$2
        
        # Check if it's a runner or module
        if [[ "$TARGET" == queztl-runner-* ]]; then
            echo "üìú Logs for $TARGET:"
            docker logs -f $TARGET
        else
            echo "üìú Recent logs for module: $TARGET"
            ls -t training_logs/${TARGET}_*.log 2>/dev/null | head -1 | xargs tail -f || echo "No logs found"
        fi
        ;;
    
    spawn)
        COUNT=${2:-1}
        echo "üêù Spawning $COUNT runner(s)..."
        
        RESULT=$(curl -s -X POST "$ORCHESTRATOR_URL/runners/spawn?count=$COUNT")
        echo "$RESULT" | python3 -c "import sys, json; d=json.load(sys.stdin); print(f\"Spawned: {', '.join(d['spawned'])}\"); print(f\"Total active: {d['total_active']}\")"
        
        echo -e "${GREEN}‚úÖ Runners spawned!${NC}"
        ;;
    
    kill)
        if [ -z "$2" ]; then
            echo "Usage: ./hive-control kill <runner-id>"
            exit 1
        fi
        
        RUNNER=$2
        echo "üíÄ Terminating $RUNNER..."
        
        curl -s -X DELETE "$ORCHESTRATOR_URL/runners/$RUNNER"
        echo -e "${GREEN}‚úÖ Runner terminated${NC}"
        ;;
    
    clean)
        echo "üßπ Cleaning training artifacts..."
        
        # Remove old logs (keep last 10)
        cd training_logs
        ls -t *.log 2>/dev/null | tail -n +11 | xargs rm -f
        cd ..
        
        # Remove stopped containers
        docker container prune -f
        
        echo -e "${GREEN}‚úÖ Cleaned!${NC}"
        ;;
    
    monitor)
        echo "üìä Monitoring hive (Ctrl+C to stop)..."
        echo ""
        
        while true; do
            clear
            $0 status
            echo ""
            echo "Refreshing in 5s..."
            sleep 5
        done
        ;;
    
    web)
        echo "üåê Opening web dashboard..."
        python3 -c "import webbrowser; webbrowser.open('http://localhost:9000/docs')"
        echo "API docs: http://localhost:9000/docs"
        ;;
    
    *)
        echo "Queztl Hive Control - Distributed Training System"
        echo ""
        echo "Usage: ./hive-control <command> [options]"
        echo ""
        echo "Setup Commands:"
        echo "  init              Initialize the training hive"
        echo "  start             Start orchestrator and initial runners"
        echo "  stop              Stop all hive components"
        echo "  restart           Restart the hive"
        echo ""
        echo "Monitoring Commands:"
        echo "  status            Show hive status"
        echo "  runners           List all training runners"
        echo "  jobs              List training jobs"
        echo "  logs <target>     View logs (runner or module)"
        echo "  monitor           Real-time monitoring"
        echo ""
        echo "Scaling Commands:"
        echo "  scale <n>         Scale to N runners"
        echo "  spawn [n]         Spawn N new runners (default: 1)"
        echo "  kill <id>         Terminate a specific runner"
        echo ""
        echo "Job Commands:"
        echo "  submit <module> [priority]  Submit a training job"
        echo ""
        echo "Maintenance Commands:"
        echo "  clean             Clean old logs and containers"
        echo "  web               Open web dashboard"
        echo ""
        echo "Examples:"
        echo "  ./hive-control init"
        echo "  ./hive-control start"
        echo "  ./hive-control scale 4"
        echo "  ./hive-control submit gis-lidar high"
        echo "  ./hive-control status"
        echo "  ./hive-control monitor"
        ;;
esac
