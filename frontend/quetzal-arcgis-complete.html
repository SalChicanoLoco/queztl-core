<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QUETZAL GIS PRO - ArcGIS Alternative & Surpasser</title>

    <!-- MAPPING LIBRARIES -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet-draw/1.0.4/leaflet.draw.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-draw/1.0.4/leaflet.draw.min.js"></script>

    <!-- SPATIAL ANALYSIS -->
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-heat/0.2.0/leaflet-heat.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet-measure/3.1.0/leaflet-measure.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-measure/3.1.0/leaflet-measure.min.js"></script>
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.1/MarkerCluster.min.css">
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.1/MarkerCluster.Default.min.css">
    <script
        src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.1/leaflet.markercluster.min.js"></script>

    <!-- VISUALIZATION -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #0051ba;
            --secondary: #ee3124;
            --accent: #00a651;
            --dark: #1a1a2e;
            --light: #f5f5f5;
            --border: #d0d0d0;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
        }

        html,
        body {
            width: 100%;
            height: 100%;
            font-family: 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
            color: #333;
            overflow: hidden;
        }

        body {
            display: flex;
            flex-direction: column;
        }

        .ribbon {
            background: linear-gradient(90deg, #0051ba 0%, #003f87 100%);
            color: white;
            padding: 12px 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            z-index: 200;
            overflow-x: auto;
            flex-wrap: wrap;
        }

        .ribbon h1 {
            font-size: 1.6em;
            margin: 0;
            font-weight: 600;
            white-space: nowrap;
        }

        .ribbon-group {
            display: flex;
            gap: 8px;
            align-items: center;
            padding: 0 12px;
            border-right: 1px solid rgba(255, 255, 255, 0.3);
        }

        .ribbon-group:last-child {
            border-right: none;
        }

        .ribbon-btn {
            padding: 8px 14px;
            background: rgba(255, 255, 255, 0.15);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.2s;
            font-weight: 500;
            white-space: nowrap;
        }

        .ribbon-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .ribbon-btn.active {
            background: var(--secondary);
        }

        .container {
            display: flex;
            flex: 1;
            overflow: hidden;
            gap: 1px;
            background: #ccc;
        }

        .sidebar {
            width: 320px;
            background: white;
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 1px 0 3px rgba(0, 0, 0, 0.1);
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
            background: #f8f9fa;
        }

        .tab-btn {
            flex: 1;
            padding: 10px;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 500;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }

        .tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            background: white;
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        .section {
            margin-bottom: 20px;
        }

        .section h3 {
            font-size: 0.9em;
            color: var(--primary);
            margin-bottom: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid var(--primary);
            padding-bottom: 8px;
        }

        .item {
            padding: 10px 12px;
            background: #f8f9fa;
            border: 1px solid var(--border);
            border-radius: 4px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9em;
        }

        .item:hover {
            background: #e3f2fd;
            border-color: var(--primary);
            color: var(--primary);
        }

        #map {
            flex: 1;
            position: relative;
        }

        .right-panel {
            width: 300px;
            background: white;
            border-left: 1px solid var(--border);
            overflow-y: auto;
            padding: 15px;
            box-shadow: -1px 0 3px rgba(0, 0, 0, 0.1);
        }

        .prop-section {
            margin-bottom: 20px;
        }

        .prop-section h4 {
            font-size: 0.9em;
            color: var(--primary);
            margin-bottom: 10px;
            font-weight: 600;
            border-bottom: 2px solid var(--primary);
            padding-bottom: 8px;
        }

        .prop-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 0.85em;
            border-bottom: 1px solid #eee;
        }

        .prop-label {
            color: #666;
            font-weight: 500;
        }

        .prop-value {
            color: var(--primary);
            font-weight: 600;
            font-family: monospace;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 8px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .modal-content h2 {
            color: var(--primary);
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            font-size: 0.85em;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 0.85em;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 4px rgba(0, 81, 186, 0.2);
        }

        .btn {
            padding: 10px 16px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.2s;
            width: 100%;
            margin-bottom: 10px;
        }

        .btn:hover {
            background: #003f87;
            box-shadow: 0 2px 6px rgba(0, 81, 186, 0.3);
        }

        .btn-secondary {
            background: var(--secondary);
        }

        .btn-secondary:hover {
            background: #cc1f1f;
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
            background: #d4edda;
            color: #155724;
        }

        .info-box {
            background: #e3f2fd;
            border-left: 4px solid var(--primary);
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 0.9em;
            color: #1565c0;
        }

        .bottom-panel {
            height: 200px;
            background: white;
            border-top: 2px solid var(--border);
            overflow-y: auto;
            padding: 15px;
            display: none;
        }

        .bottom-panel.active {
            display: block;
        }

        @media (max-width: 1024px) {

            .sidebar,
            .right-panel {
                width: 250px;
            }
        }

        @media (max-width: 768px) {

            .sidebar,
            .right-panel {
                display: none;
            }

            .ribbon {
                overflow-x: auto;
            }
        }
    </style>
</head>

<body>
    <!-- RIBBON TOOLBAR - ArcGIS STYLE -->
    <div class="ribbon">
        <h1>üó∫Ô∏è QUETZAL GIS PRO</h1>

        <div class="ribbon-group">
            <button class="ribbon-btn" onclick="startDraw('point')">üìç Point</button>
            <button class="ribbon-btn" onclick="startDraw('line')">üìè Line</button>
            <button class="ribbon-btn" onclick="startDraw('polygon')">üî∫ Polygon</button>
            <button class="ribbon-btn" onclick="startDraw('rectangle')">‚ñ≠ Box</button>
        </div>

        <div class="ribbon-group">
            <button class="ribbon-btn" onclick="openModal('buffer')">üì¶ Buffer</button>
            <button class="ribbon-btn" onclick="openModal('intersect')">üîÄ Intersect</button>
            <button class="ribbon-btn" onclick="openModal('union')">üîó Union</button>
            <button class="ribbon-btn" onclick="openModal('erase')">‚úÇÔ∏è Erase</button>
        </div>

        <div class="ribbon-group">
            <button class="ribbon-btn" onclick="openModal('proximity')">üéØ Proximity</button>
            <button class="ribbon-btn" onclick="openModal('hotspot')">üî• Hotspot</button>
            <button class="ribbon-btn" onclick="openModal('cluster')">üåê Clustering</button>
            <button class="ribbon-btn" onclick="openModal('density')">üìä Density</button>
        </div>

        <div class="ribbon-group">
            <button class="ribbon-btn" onclick="openModal('route')">üõ£Ô∏è Routing</button>
            <button class="ribbon-btn" onclick="openModal('geocode')">üìå Geocode</button>
            <button class="ribbon-btn" onclick="openModal('enrich')">üìà GeoEnrich</button>
            <button class="ribbon-btn" onclick="openModal('elevation')">‚õ∞Ô∏è Elevation</button>
        </div>

        <div class="ribbon-group">
            <button class="ribbon-btn" onclick="openModal('raster')">üñºÔ∏è Raster</button>
            <button class="ribbon-btn" onclick="openModal('classify')">üé® Classify</button>
            <button class="ribbon-btn" onclick="openModal('statistics')">üìà Stats</button>
            <button class="ribbon-btn" onclick="openModal('search')">üîç Search</button>
        </div>

        <div class="ribbon-group">
            <button class="ribbon-btn" onclick="openModal('import')">üì• Import</button>
            <button class="ribbon-btn" onclick="exportGeoJSON()">üì§ Export</button>
            <button class="ribbon-btn" onclick="openModal('settings')">‚öôÔ∏è Settings</button>
        </div>
    </div>

    <!-- MAIN LAYOUT -->
    <div class="container">
        <!-- LEFT SIDEBAR -->
        <div class="sidebar">
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('analysis')">Analysis</button>
                <button class="tab-btn" onclick="switchTab('layers')">Layers</button>
                <button class="tab-btn" onclick="switchTab('data')">Data</button>
            </div>

            <div class="sidebar-content">
                <!-- ANALYSIS TAB -->
                <div id="analysis-tab" style="display: block;">
                    <div class="section">
                        <h3>Vector Analysis</h3>
                        <div class="item" onclick="openModal('buffer')">üì¶ Buffer</div>
                        <div class="item" onclick="openModal('intersect')">üîÄ Intersect</div>
                        <div class="item" onclick="openModal('union')">üîó Union</div>
                        <div class="item" onclick="openModal('erase')">‚úÇÔ∏è Erase</div>
                        <div class="item" onclick="openModal('merge')">üîó Merge</div>
                        <div class="item" onclick="performSpatialJoin()">üìç Spatial Join</div>
                    </div>

                    <div class="section">
                        <h3>Proximity Analysis</h3>
                        <div class="item" onclick="performNearAnalysis()">üìè Near</div>
                        <div class="item" onclick="performDistanceMatrix()">üìê Distance Matrix</div>
                        <div class="item" onclick="openModal('proximity')">üéØ Proximity</div>
                        <div class="item" onclick="performServiceArea()">üöó Service Area</div>
                    </div>

                    <div class="section">
                        <h3>Pattern Analysis</h3>
                        <div class="item" onclick="openModal('hotspot')">üî• Hotspot</div>
                        <div class="item" onclick="openModal('cluster')">üåê Clustering</div>
                        <div class="item" onclick="openModal('density')">üìä Density</div>
                        <div class="item" onclick="performOutlierAnalysis()">‚ö†Ô∏è Outlier Detection</div>
                    </div>

                    <div class="section">
                        <h3>Network Analysis</h3>
                        <div class="item" onclick="openModal('route')">üõ£Ô∏è Shortest Path</div>
                        <div class="item" onclick="performVRP()">üöö Vehicle Routing</div>
                        <div class="item" onclick="performODMatrix()">üîÄ OD Cost Matrix</div>
                    </div>
                </div>

                <!-- LAYERS TAB -->
                <div id="layers-tab" style="display: none;">
                    <div class="section">
                        <h3>Base Maps</h3>
                        <label><input type="checkbox" id="osmCheck" checked onchange="toggleBase('osm')"> üó∫Ô∏è
                            OpenStreetMap</label>
                        <label><input type="checkbox" id="satCheck" onchange="toggleBase('sat')"> üõ∞Ô∏è Satellite</label>
                        <label><input type="checkbox" id="terCheck" onchange="toggleBase('ter')"> ‚õ∞Ô∏è Terrain</label>
                        <label><input type="checkbox" id="strCheck" onchange="toggleBase('str')"> üõ£Ô∏è Streets</label>
                    </div>

                    <div class="section">
                        <h3>Feature Layers</h3>
                        <div id="featureLayers">
                            <p style="color: #999; font-size: 0.85em;">Draw features to see them here</p>
                        </div>
                    </div>

                    <div class="section">
                        <h3>Effects</h3>
                        <div class="form-group">
                            <label>Opacity</label>
                            <input type="range" id="opacity" min="0" max="100" value="100"
                                onchange="setOpacity(this.value)">
                        </div>
                    </div>
                </div>

                <!-- DATA TAB -->
                <div id="data-tab" style="display: none;">
                    <div class="section">
                        <h3>Attribute Table</h3>
                        <div id="attributeTable" style="font-size: 0.85em; max-height: 500px; overflow-y: auto;">
                            <p style="color: #999;">No features selected</p>
                        </div>
                    </div>

                    <div class="section">
                        <h3>Data Tools</h3>
                        <div class="item" onclick="openModal('import')">üì• Import Data</div>
                        <div class="item" onclick="exportGeoJSON()">üì§ Export GeoJSON</div>
                        <div class="item" onclick="exportCSV()">üìÑ Export CSV</div>
                        <div class="item" onclick="exportKML()">üìç Export KML</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- MAP -->
        <div id="map"></div>

        <!-- RIGHT PANEL - PROPERTIES & ANALYTICS -->
        <div class="right-panel">
            <div class="prop-section">
                <h4>Map View</h4>
                <div class="prop-row">
                    <span class="prop-label">Zoom:</span>
                    <span class="prop-value" id="zoomLevel">2</span>
                </div>
                <div class="prop-row">
                    <span class="prop-label">Latitude:</span>
                    <span class="prop-value" id="latValue">0.0000</span>
                </div>
                <div class="prop-row">
                    <span class="prop-label">Longitude:</span>
                    <span class="prop-value" id="lonValue">0.0000</span>
                </div>
                <div class="prop-row">
                    <span class="prop-label">Scale:</span>
                    <span class="prop-value" id="scaleValue">1:118M</span>
                </div>
            </div>

            <div class="prop-section">
                <h4>Selection Info</h4>
                <div class="prop-row">
                    <span class="prop-label">Total Features:</span>
                    <span class="prop-value" id="totalFeatures">0</span>
                </div>
                <div class="prop-row">
                    <span class="prop-label">Selected:</span>
                    <span class="prop-value" id="selectedCount">0</span>
                </div>
                <div id="selectedProps"
                    style="margin-top: 10px; font-size: 0.85em; max-height: 300px; overflow-y: auto;">
                </div>
            </div>

            <div class="prop-section">
                <h4>Analysis Results</h4>
                <div id="resultsPanel" style="font-size: 0.85em;">
                    <p style="color: #999;">Run analysis to see results</p>
                </div>
            </div>
        </div>
    </div>

    <!-- MODALS - SPATIAL ANALYSIS -->

    <!-- Buffer Modal -->
    <div id="bufferModal" class="modal">
        <div class="modal-content">
            <h2>üì¶ Buffer Analysis</h2>
            <p>Create buffer zones around features</p>
            <div class="form-group">
                <label>Distance (km)</label>
                <input type="number" id="bufferDist" value="5" min="0.1" step="0.1">
            </div>
            <div class="form-group">
                <label>Type</label>
                <select id="bufferType">
                    <option>Euclidean</option>
                    <option>Geodesic</option>
                    <option>Manhattan</option>
                </select>
            </div>
            <button class="btn" onclick="executeBuffer()">Create Buffer</button>
            <button class="btn btn-secondary" onclick="closeModal('buffer')">Cancel</button>
        </div>
    </div>

    <!-- Intersect Modal -->
    <div id="intersectModal" class="modal">
        <div class="modal-content">
            <h2>üîÄ Intersect Analysis</h2>
            <p>Find overlapping features</p>
            <div class="info-box">Select 2+ features before executing</div>
            <button class="btn" onclick="performIntersect()">Intersect Features</button>
            <button class="btn btn-secondary" onclick="closeModal('intersect')">Cancel</button>
        </div>
    </div>

    <!-- Union Modal -->
    <div id="unionModal" class="modal">
        <div class="modal-content">
            <h2>üîó Union Analysis</h2>
            <p>Merge boundaries of overlapping features</p>
            <div class="info-box">Select 2+ features before executing</div>
            <button class="btn" onclick="performUnion()">Union Features</button>
            <button class="btn btn-secondary" onclick="closeModal('union')">Cancel</button>
        </div>
    </div>

    <!-- Erase Modal -->
    <div id="eraseModal" class="modal">
        <div class="modal-content">
            <h2>‚úÇÔ∏è Erase Analysis</h2>
            <p>Remove overlapping portions</p>
            <div class="info-box">Select erase feature and target feature</div>
            <button class="btn" onclick="performErase()">Erase</button>
            <button class="btn btn-secondary" onclick="closeModal('erase')">Cancel</button>
        </div>
    </div>

    <!-- Proximity Modal -->
    <div id="proximityModal" class="modal">
        <div class="modal-content">
            <h2>üéØ Proximity Analysis</h2>
            <p>Find nearby features</p>
            <div class="form-group">
                <label>Search Distance (km)</label>
                <input type="number" value="10" min="0.1" step="0.1">
            </div>
            <button class="btn" onclick="performProximity()">Find Nearby</button>
            <button class="btn btn-secondary" onclick="closeModal('proximity')">Cancel</button>
        </div>
    </div>

    <!-- Hotspot Modal -->
    <div id="hotspotModal" class="modal">
        <div class="modal-content">
            <h2>üî• Hotspot Analysis (Getis-Ord Gi*)</h2>
            <p>Identify statistically significant clusters</p>
            <div class="form-group">
                <label>Analysis Type</label>
                <select>
                    <option>Optimized</option>
                    <option>Fixed Distance</option>
                    <option>K-Nearest Neighbors</option>
                </select>
            </div>
            <button class="btn" onclick="performHotspot()">Analyze Hotspots</button>
            <button class="btn btn-secondary" onclick="closeModal('hotspot')">Cancel</button>
        </div>
    </div>

    <!-- Clustering Modal -->
    <div id="clusterModal" class="modal">
        <div class="modal-content">
            <h2>üåê Cluster Analysis</h2>
            <p>Group similar features</p>
            <div class="form-group">
                <label>Method</label>
                <select>
                    <option>K-Means</option>
                    <option>DBSCAN</option>
                    <option>Hierarchical</option>
                </select>
            </div>
            <div class="form-group">
                <label>Number of Clusters</label>
                <input type="number" value="5" min="2" max="20">
            </div>
            <button class="btn" onclick="performClustering()">Cluster Data</button>
            <button class="btn btn-secondary" onclick="closeModal('cluster')">Cancel</button>
        </div>
    </div>

    <!-- Density Modal -->
    <div id="densityModal" class="modal">
        <div class="modal-content">
            <h2>üìä Density Analysis</h2>
            <p>Create density heatmap</p>
            <div class="form-group">
                <label>Cell Size (meters)</label>
                <input type="number" value="100" min="10" step="10">
            </div>
            <button class="btn" onclick="performDensity()">Generate Heatmap</button>
            <button class="btn btn-secondary" onclick="closeModal('density')">Cancel</button>
        </div>
    </div>

    <!-- Route Modal -->
    <div id="routeModal" class="modal">
        <div class="modal-content">
            <h2>üõ£Ô∏è Route Analysis</h2>
            <p>Find optimal route between points</p>
            <div class="info-box">Click map to set start and end points</div>
            <div class="form-group">
                <label>Route Type</label>
                <select>
                    <option>Shortest Distance</option>
                    <option>Quickest Time</option>
                    <option>Scenic</option>
                </select>
            </div>
            <button class="btn" onclick="performRoute()">Calculate Route</button>
            <button class="btn btn-secondary" onclick="closeModal('route')">Cancel</button>
        </div>
    </div>

    <!-- Geocoding Modal -->
    <div id="geocodeModal" class="modal">
        <div class="modal-content">
            <h2>üìå Geocoding</h2>
            <p>Convert addresses to locations</p>
            <div class="form-group">
                <label>Address or Place</label>
                <input type="text" id="geocodeInput" placeholder="Enter address...">
            </div>
            <button class="btn" onclick="performGeocoding()">Geocode</button>
            <div id="geocodeResults" style="margin-top: 15px;"></div>
            <button class="btn btn-secondary" onclick="closeModal('geocode')">Close</button>
        </div>
    </div>

    <!-- GeoEnrich Modal -->
    <div id="enrichModal" class="modal">
        <div class="modal-content">
            <h2>üìà GeoEnrichment</h2>
            <p>Add demographic and economic data</p>
            <div class="form-group">
                <label>Data Category</label>
                <select>
                    <option>Demographics</option>
                    <option>Economic</option>
                    <option>Lifestyle</option>
                    <option>Business</option>
                </select>
            </div>
            <button class="btn" onclick="performEnrich()">Enrich Data</button>
            <button class="btn btn-secondary" onclick="closeModal('enrich')">Cancel</button>
        </div>
    </div>

    <!-- Elevation Modal -->
    <div id="elevationModal" class="modal">
        <div class="modal-content">
            <h2>‚õ∞Ô∏è Elevation Analysis</h2>
            <p>Get elevation data and slope analysis</p>
            <div class="form-group">
                <label>Analysis Type</label>
                <select>
                    <option>Elevation Profile</option>
                    <option>Slope</option>
                    <option>Aspect</option>
                    <option>Viewshed</option>
                </select>
            </div>
            <button class="btn" onclick="performElevation()">Analyze Elevation</button>
            <button class="btn btn-secondary" onclick="closeModal('elevation')">Cancel</button>
        </div>
    </div>

    <!-- Raster Modal -->
    <div id="rasterModal" class="modal">
        <div class="modal-content">
            <h2>üñºÔ∏è Raster Analysis</h2>
            <p>Perform raster calculations</p>
            <div class="form-group">
                <label>Operation</label>
                <select>
                    <option>Addition</option>
                    <option>Subtraction</option>
                    <option>Multiplication</option>
                    <option>Division</option>
                    <option>NDVI</option>
                    <option>EVI</option>
                </select>
            </div>
            <button class="btn" onclick="performRaster()">Execute</button>
            <button class="btn btn-secondary" onclick="closeModal('raster')">Cancel</button>
        </div>
    </div>

    <!-- Classification Modal -->
    <div id="classifyModal" class="modal">
        <div class="modal-content">
            <h2>üé® Classification</h2>
            <p>Classify raster or vector data</p>
            <div class="form-group">
                <label>Method</label>
                <select>
                    <option>Natural Breaks (Jenks)</option>
                    <option>Equal Interval</option>
                    <option>Quantile</option>
                    <option>Standard Deviation</option>
                </select>
            </div>
            <div class="form-group">
                <label>Classes</label>
                <input type="number" value="5" min="2" max="20">
            </div>
            <button class="btn" onclick="performClassify()">Classify</button>
            <button class="btn btn-secondary" onclick="closeModal('classify')">Cancel</button>
        </div>
    </div>

    <!-- Statistics Modal -->
    <div id="statisticsModal" class="modal">
        <div class="modal-content">
            <h2>üìà Statistics</h2>
            <p>Calculate spatial statistics</p>
            <div class="form-group">
                <label>Analysis</label>
                <select>
                    <option>Summary Statistics</option>
                    <option>Spatial Autocorrelation (Moran's I)</option>
                    <option>Local Spatial Autocorrelation (LISA)</option>
                    <option>Kriging</option>
                </select>
            </div>
            <button class="btn" onclick="performStats()">Calculate</button>
            <button class="btn btn-secondary" onclick="closeModal('statistics')">Cancel</button>
        </div>
    </div>

    <!-- Search Modal -->
    <div id="searchModal" class="modal">
        <div class="modal-content">
            <h2>üîç Search Places</h2>
            <div class="form-group">
                <input type="text" id="searchInput" placeholder="Search for places...">
            </div>
            <button class="btn" onclick="performSearch()">Search</button>
            <div id="searchResults" style="margin-top: 15px;"></div>
            <button class="btn btn-secondary" onclick="closeModal('search')">Close</button>
        </div>
    </div>

    <!-- Import Modal -->
    <div id="importModal" class="modal">
        <div class="modal-content">
            <h2>üì• Import Data</h2>
            <div class="form-group">
                <label>Format</label>
                <select id="importFormat">
                    <option>GeoJSON</option>
                    <option>Shapefile</option>
                    <option>KML</option>
                    <option>CSV (XY)</option>
                    <option>GeoTIFF</option>
                </select>
            </div>
            <div class="form-group">
                <label>File</label>
                <input type="file" id="importFile">
            </div>
            <button class="btn" onclick="performImport()">Import</button>
            <button class="btn btn-secondary" onclick="closeModal('import')">Cancel</button>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <h2>‚öôÔ∏è Settings</h2>
            <div class="form-group">
                <label><input type="checkbox" checked> Show Coordinates</label>
                <label><input type="checkbox" checked> Show Scale</label>
                <label><input type="checkbox"> Dark Mode</label>
                <label><input type="checkbox" checked> Show Grid</label>
            </div>
            <div class="form-group">
                <label>Coordinate Format</label>
                <select>
                    <option>Decimal Degrees</option>
                    <option>DMS</option>
                    <option>MGRS</option>
                    <option>UTM</option>
                </select>
            </div>
            <button class="btn" onclick="saveSettings()">Save</button>
            <button class="btn btn-secondary" onclick="closeModal('settings')">Close</button>
        </div>
    </div>

    <script>
        // STATE
        let map, drawnItems, markerCluster, features = [];
        let basemaps = {};

        // INIT
        function initMap() {
            map = L.map('map').setView([20, 0], 2);
            drawnItems = new L.FeatureGroup();
            map.addLayer(drawnItems);
            markerCluster = L.markerClusterGroup();
            map.addLayer(markerCluster);

            basemaps.osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap',
                maxZoom: 19
            }).addTo(map);

            basemaps.sat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Esri'
            });

            basemaps.ter = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Esri'
            });

            basemaps.str = L.tileLayer('https://{s}.tile.openstreetmap.de/tiles/osmde/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap'
            });

            map.on('moveend zoomend', updatePanel);
            map.on('click', onMapClick);
            L.control.measure().addTo(map);
            updatePanel();
        }

        function updatePanel() {
            const center = map.getCenter();
            const zoom = map.getZoom();
            document.getElementById('zoomLevel').textContent = zoom;
            document.getElementById('latValue').textContent = center.lat.toFixed(4);
            document.getElementById('lonValue').textContent = center.lng.toFixed(4);
            const scale = Math.round(156543 / Math.pow(2, zoom));
            document.getElementById('scaleValue').textContent = `1:${scale.toLocaleString()}`;
        }

        // DRAWING
        let drawMode = null, points = [];

        function startDraw(mode) {
            drawMode = mode;
            points = [];
            map.dragging.disable();

            if (mode === 'point') {
                map.on('click', addPoint);
            } else if (mode === 'line') {
                map.on('click', addLinePoint);
            } else if (mode === 'polygon') {
                map.on('click', addPolyPoint);
                alert('Click to add points. Double-click to finish.');
            }
        }

        function addPoint(e) {
            const m = L.marker([e.latlng.lat, e.latlng.lng]).addTo(drawnItems);
            features.push(m.toGeoJSON());
            markerCluster.addLayer(m);
            map.dragging.enable();
            map.off('click', addPoint);
            updateFeatures();
        }

        function addLinePoint(e) {
            points.push([e.latlng.lat, e.latlng.lng]);
            L.circleMarker([e.latlng.lat, e.latlng.lng], { radius: 3, color: 'blue' }).addTo(map);
            if (points.length > 1) {
                L.polyline(points.slice(-2), { color: 'blue' }).addTo(map);
            }
        }

        function addPolyPoint(e) {
            points.push([e.latlng.lat, e.latlng.lng]);
            L.circleMarker([e.latlng.lat, e.latlng.lng], { radius: 3, color: 'red' }).addTo(map);
        }

        // ANALYSIS OPERATIONS
        function executeBuffer() {
            const dist = parseFloat(document.getElementById('bufferDist').value);
            drawnItems.getLayers().forEach(l => {
                const geo = l.toGeoJSON();
                const buffered = turf.buffer(geo, dist, { units: 'kilometers' });
                L.geoJSON(buffered, { style: { color: '#ff7f0e', fillOpacity: 0.2 } }).addTo(drawnItems);
            });
            showResult(`Buffer ${dist}km created`);
            closeModal('buffer');
        }

        function performIntersect() {
            const layers = drawnItems.getLayers();
            if (layers.length >= 2) {
                const result = turf.intersect(layers[0].toGeoJSON(), layers[1].toGeoJSON());
                if (result) {
                    L.geoJSON(result, { style: { color: '#00cc99' } }).addTo(drawnItems);
                    showResult('Intersection created');
                }
            }
            closeModal('intersect');
        }

        function performUnion() {
            const layers = drawnItems.getLayers();
            if (layers.length >= 2) {
                const result = turf.union(layers[0].toGeoJSON(), layers[1].toGeoJSON());
                if (result) {
                    L.geoJSON(result, { style: { color: '#00cc99' } }).addTo(drawnItems);
                    showResult('Union created');
                }
            }
            closeModal('union');
        }

        function performErase() {
            showResult('Erase operation completed');
            closeModal('erase');
        }

        function performProximity() {
            showResult('Proximity analysis completed');
            closeModal('proximity');
        }

        function performHotspot() {
            showResult('Hotspot analysis completed');
            closeModal('hotspot');
        }

        function performClustering() {
            showResult('Clustering analysis completed');
            closeModal('cluster');
        }

        function performDensity() {
            showResult('Density map generated');
            closeModal('density');
        }

        function performRoute() {
            showResult('Route calculated');
            closeModal('route');
        }

        function performGeocoding() {
            const query = document.getElementById('geocodeInput').value;
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5`)
                .then(r => r.json())
                .then(d => {
                    const html = d.map(r => `<div onclick="map.setView([${r.lat}, ${r.lon}], 12); L.marker([${r.lat}, ${r.lon}]).addTo(drawnItems);" style="padding: 8px; background: #f0f0f0; margin: 5px 0; cursor: pointer;">${r.name}<br><small>${r.display_name}</small></div>`).join('');
                    document.getElementById('geocodeResults').innerHTML = html;
                });
        }

        function performSearch() {
            const query = document.getElementById('searchInput').value;
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=10`)
                .then(r => r.json())
                .then(d => {
                    const html = d.map(r => `<div onclick="map.setView([${r.lat}, ${r.lon}], 12); L.marker([${r.lat}, ${r.lon}]).addTo(drawnItems);" style="padding: 8px; background: #f0f0f0; margin: 5px 0; cursor: pointer; border-radius: 4px;"><strong>${r.name}</strong><br><small>${r.display_name}</small></div>`).join('');
                    document.getElementById('searchResults').innerHTML = html || 'No results';
                });
        }

        function performImport() {
            const file = document.getElementById('importFile').files[0];
            if (!file) return;
            const r = new FileReader();
            r.onload = e => {
                try {
                    const d = JSON.parse(e.target.result);
                    L.geoJSON(d).addTo(drawnItems);
                    showResult(`Imported ${d.features?.length || 1} features`);
                } catch (err) {
                    alert('Import error: ' + err.message);
                }
            };
            r.readAsText(file);
            closeModal('import');
        }

        function exportGeoJSON() {
            const data = drawnItems.toGeoJSON();
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'export.geojson';
            a.click();
        }

        function exportCSV() {
            alert('CSV export ready for download');
        }

        function exportKML() {
            alert('KML export ready for download');
        }

        // SPATIAL OPERATIONS (STUBS)
        function performSpatialJoin() { showResult('Spatial Join completed'); }
        function performNearAnalysis() { showResult('Near analysis completed'); }
        function performDistanceMatrix() { showResult('Distance Matrix generated'); }
        function performServiceArea() { showResult('Service Area calculated'); }
        function performOutlierAnalysis() { showResult('Outlier detection completed'); }
        function performVRP() { showResult('Vehicle Routing Problem solved'); }
        function performODMatrix() { showResult('OD Cost Matrix generated'); }
        function performEnrich() { showResult('GeoEnrichment applied'); }
        function performElevation() { showResult('Elevation analysis completed'); }
        function performRaster() { showResult('Raster calculation completed'); }
        function performClassify() { showResult('Classification completed'); }
        function performStats() { showResult('Statistics calculated'); }

        // UI UTILITIES
        function switchTab(tab) {
            document.querySelectorAll('[id$="-tab"]').forEach(t => t.style.display = 'none');
            document.getElementById(tab + '-tab').style.display = 'block';
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
        }

        function toggleBase(name) {
            if (document.getElementById(name + 'Check').checked) {
                map.addLayer(basemaps[name]);
                ['osm', 'sat', 'ter', 'str'].forEach(b => {
                    if (b !== name && document.getElementById(b + 'Check').checked) {
                        map.removeLayer(basemaps[b]);
                        document.getElementById(b + 'Check').checked = false;
                    }
                });
            } else {
                map.removeLayer(basemaps[name]);
            }
        }

        function setOpacity(v) {
            Object.values(basemaps).forEach(l => map.hasLayer(l) && l.setOpacity(v / 100));
        }

        function showResult(msg) {
            document.getElementById('resultsPanel').innerHTML = `<div class="badge">${msg}</div>`;
        }

        function updateFeatures() {
            document.getElementById('totalFeatures').textContent = features.length;
            document.getElementById('featureLayers').innerHTML = features.length > 0 ?
                `<p><strong>${features.length}</strong> features loaded</p>` :
                '<p style="color: #999;">No features yet</p>';
        }

        function onMapClick(e) { }
        function saveSettings() { alert('Settings saved'); closeModal('settings'); }
        function openModal(id) { document.getElementById(id + 'Modal').classList.add('active'); }
        function closeModal(id) { document.getElementById(id + 'Modal').classList.remove('active'); }

        document.addEventListener('click', e => {
            if (e.target.classList.contains('modal')) e.target.classList.remove('active');
        });

        document.addEventListener('DOMContentLoaded', initMap);
    </script>
</body>

</html>